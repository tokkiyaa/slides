## SQL生成を
## 読みやすく書くための
## 5つのポイント

---
## 導入

---
### SQLを生成するコードを
### 書いたことありますか？

---
### ORマッパや言語内DSLを通さずに、
### SQLを生成するコードを
### 書いたことありますか？

---
### ほとんどのシステムには、
### そういうコードがあるはず

---
### ORマッパや言語内DSLは
### 生のSQLを完全に代替しない
- RDBMS毎の方言
  - RDBMSによって使えたり使えなかったりする文法(WITH句など)
  - 多様な関数

- チューニングしようとすると「生のSQL」にアクセスしやすい方が楽

---
## 明らかに負債になりやすい部分
- システムが成長し機能が増える毎に、複雑になっていくクエリ

- 致命的なデグレにつながりやすく、リファクタに伴うリスク・コストは大きい

- パフォーマンス面でのボトルネックになりやすい

---
## 書くことを避けられないならば

---
## ベストプラクティス的なもの、欲しくない?

---
## このスライドについて

- 説明しないこと
  - SQLインジェクション対策(Prepared Statement使うとか無害化とか)

- 説明すること
  - 複雑なSQLを文字列ベースで生成する際に気をつけること

---
## このスライドについて
- 注意書き
  - 特に権威のある人のソースを参考にしていたりはしないので、ある程度疑ってかかったほうがいいかも(予防線)

---
## SQL生成を
## 読みやすく書くための
## 5つのポイント

---
### 読みやすさ:「他の人が最短で理解できること」

---
### プログラミングにおける
### 一般的なコードの読みやすさの要素
- [『Code Complete』](https://www.amazon.co.jp/CODE-COMPLETE-第2版-上-完全なプログラミングを目指して/dp/489100455X)
- [『リーダブルコード』](https://www.amazon.co.jp/リーダブルコード-より良いコードを書くためのシンプルで実践的なテクニック-Theory-practice-Boswell/dp/4873115655/ref=pd_lpo_sbs_14_t_0?_encoding=UTF8&psc=1&refRID=MTC0ZC4H4967XPFNW86Z)
- ↑ここら辺に書いてある

---
### SQL生成の文脈における
### 読みやすさの要素
- SQLを生成するコードの読みやすさ
- 生成後のSQLの読みやすさ

---
## １．最終的に「読みやすいSQL」が生成されるようにする
- 読み手は「最終的には読みやすいSQLが生成されているはず(されていてほしい)」という先入観を持っている<br/>
  -> その先入観を活かしたコードを書くべき

- 読みやすいSQLの方が、デバッグ・チューニングしやすく、変更に強い(当たり前...)

---
### 最終的に「読みやすいSQL」にするためにやることの例...

- なるべく標準的なSQL(ISO/IEC 9075に規定されている文法)を使う

- スタイルを整える
    - 大文字・小文字の規則は統一する

- [その他](http://www.sqlstyle.guide/ja/)

---
### やらなくていいこと
### (やらないべきこと)
- 最終的に生成されるSQLは、改行・インデントは適当でOK

- むしろ、SQLを生成するコード内における改行・インデントが大切

---?code=1.write_standard_sql_BAD.sql
- 悪い例
- DECODEはCASE式でいい感じに代替できるので使わないべき。

---?code=1.write_standard_sql_GOOD.sql
- 良い例

---
### ２．適切な単位で変数化・関数化する

#### プログラミングにおいては「当たり前」
#### だけど、本当にできてる？

---
## SQLの構文を改めて調べてみる

[BNFを見てみる](https://github.com/ronsavage/SQL/blob/master/sql-99.bnf.html)

ちょっとハードル高め？

---
## 注目ポイント

```
<subquery> ::=
      <left paren> <query expression> <right paren>
```

---
## 句の間の依存関係に着目する
- select句, where句, groupBy句は、from句のテーブルや別名に依存
- select句は、group by句で指定した項目にも依存
- ↑など、句の句の間に依存関係がある

---
## 変数または関数の適切な単位

---
### 適切な1単位
- クエリ
- select要素
- 条件
- grouping要素

---
## 適切でない単位
- 句
- サブクエリ

---?code=2.separate_properly_BAD.scala
- 悪い例
- 句とサブクエリの単位で変数を作ったことで、変更を加えにくくなってる

---?code=2.separate_properly_GOOD.scala
- 良い例

---
## ３. 適切に命名する
#### アプリケーションハンガリアン的な命名...?
- クエリ: hogeQuery
- select項目: hogeItem
- select項目(複数): hogeItems
- 抽出条件: hogeCondition
- 抽出条件(複数): hogeConditions
- 結合条件: hoge-hageJoinCondition
- 結合条件(複数): hoge-hageJoinConditions

---
## ４．適切に分けて、組み合わせる
- サブクエリは変数に分離する
- クエリの段毎に組み合わせる

---?code=4.combination_BAD.scala
- 悪い例
- 一段目のクエリと二段目のクエリに、
- 同時に変数を書き入れようとしているため、見通しが悪い

---?code=4.combination_GOOD.scala
- 良い例

---
## ５．相関がある要素は、ベタ文字で書かずに共有する
- 句の間で相関がある項目
  - テーブルやクエリの別名
  - group by句で指定した項目

- 親子クエリ間で相関がある項目
  - select項目

---
定数や引数渡しなどで、参照を共有する!

---
## 以上です。ご静聴ありがとうございました。是非、皆さんのやり方も聞きたいです！
